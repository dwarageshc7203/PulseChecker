<!DOCTYPE html>
<html>
<head>
  <title>Pulse Rate Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial;
      text-align: center;
      padding: 20px;
    }
    video {
      width: 100%;
      max-width: 300px;
      border-radius: 10px;
    }
    h1 {
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2>Pulse Rate Measurement</h2>
  <p>Place your finger on the camera</p>

  <video id="video" autoplay></video>
  <h1 id="bpm">BPM: --</h1>

<script>
const video = document.getElementById("video");
const bpmText = document.getElementById("bpm");

let lastPeakTime = 0;
let beats = [];

navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
.then(stream => {
  video.srcObject = stream;
})
.catch(err => alert("Camera access denied"));

const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");

setInterval(() => {
  if (video.videoWidth === 0) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
  let redSum = 0;

  for (let i = 0; i < frame.data.length; i += 4) {
    redSum += frame.data[i]; // red channel
  }

  const redAvg = redSum / (frame.data.length / 4);
  detectBeat(redAvg);

}, 100);

function detectBeat(value) {
  const now = Date.now();

  if (value < 100 && now - lastPeakTime > 600) {
    beats.push(now);
    lastPeakTime = now;
  }

  beats = beats.filter(t => now - t < 10000);

  if (beats.length >= 2) {
    const interval = beats[beats.length - 1] - beats[0];
    const bpm = Math.round((beats.length - 1) * 60000 / interval);
    bpmText.innerText = "BPM: " + bpm;
  }
}
</script>

</body>
</html>
